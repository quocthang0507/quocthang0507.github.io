document.addEventListener("DOMContentLoaded",function(){let e,t=loadFromLocalStorage("worldClocks")||[],n={showSeconds:!0,showNumbers:!0,showDigital:!0,theme:"light"};const o=loadFromLocalStorage("worldClocksSettings");o&&(n={...n,...o}),document.getElementById("show-seconds").checked=n.showSeconds,document.getElementById("show-numbers").checked=n.showNumbers,document.getElementById("show-digital").checked=n.showDigital,document.getElementById("clock-theme").value=n.theme;const i={"Asia/Ho_Chi_Minh":"Hanoi","Asia/Tokyo":"Tokyo","Asia/Shanghai":"Beijing","Asia/Seoul":"Seoul","Asia/Singapore":"Singapore","Asia/Bangkok":"Bangkok","Asia/Dubai":"Dubai","Europe/London":"London","Europe/Paris":"Paris","Europe/Berlin":"Berlin","Europe/Moscow":"Moscow","America/New_York":"New York","America/Los_Angeles":"Los Angeles","America/Chicago":"Chicago","America/Toronto":"Toronto","America/Sao_Paulo":"São Paulo","Australia/Sydney":"Sydney","Pacific/Auckland":"Auckland"};function c(){const e=document.getElementById("timezone-selector").value,t=(new Date).toLocaleString("en-US",{timeZone:e,hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});document.getElementById("selected-time-display").value=t}function a(e,n){if(t.some(t=>t.timezone===e))return void showAlert("Đồng hồ này đã tồn tại!","warning");if(t.length>=12)return void showAlert("Chỉ có thể thêm tối đa 12 đồng hồ!","warning");const o={id:Date.now(),timezone:e,cityName:n||i[e]||e};t.push(o),s(),l(),showAlert(`Đã thêm đồng hồ ${o.cityName}!`,"success"),"undefined"!=typeof gtag&&gtag("event","clock_added",{event_category:"world_clocks",event_label:e,city_name:o.cityName})}function s(){saveToLocalStorage("worldClocks",t)}function l(){const e=document.getElementById("clocks-container");0!==t.length?(e.innerHTML=t.map(e=>`\n            <div class="col-lg-3 col-md-4 col-sm-6">\n                <div class="clock-item">\n                    <canvas class="clock-canvas" id="clock-${e.id}" width="250" height="250"></canvas>\n                    <div class="clock-city-name">${e.cityName}</div>\n                    <div class="clock-digital-time" id="digital-${e.id}">00:00:00</div>\n                    <div class="clock-date" id="date-${e.id}">Loading...</div>\n                    <div class="clock-timezone">${e.timezone}</div>\n                    <button class="btn btn-sm btn-outline-danger clock-remove-btn" onclick="window.worldClocksRemove(${e.id})">\n                        <i class="fas fa-trash"></i> Remove\n                    </button>\n                </div>\n            </div>\n        `).join(""),r()):e.innerHTML='\n                <div class="col-12">\n                    <div class="text-center text-muted py-5">\n                        <i class="fas fa-clock fa-3x mb-3"></i>\n                        <p>Chưa có đồng hồ nào. Hãy thêm đồng hồ từ danh sách bên dưới!</p>\n                    </div>\n                </div>\n            '}function d(e,t,n,o,i,c,a){e.beginPath(),e.moveTo(t,n),e.lineTo(t+i*Math.cos(o),n+i*Math.sin(o)),e.strokeStyle=a,e.lineWidth=c,e.lineCap="round",e.stroke()}function r(){t.forEach(e=>{const t=document.getElementById(`clock-${e.id}`),o=document.getElementById(`digital-${e.id}`),i=document.getElementById(`date-${e.id}`);if(!t)return;const c=new Date,a=c.toLocaleString("en-US",{timeZone:e.timezone,hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),s=c.toLocaleDateString("en-US",{timeZone:e.timezone,weekday:"short",year:"numeric",month:"short",day:"numeric"}),[l,r,h]=a.split(":").map(Number),m=new Date;m.setHours(l),m.setMinutes(r),m.setSeconds(h),function(e,t){const o=e.getContext("2d"),i=e.width/2,c=i,a=i;let s,l,r,h,m;switch(o.clearRect(0,0,e.width,e.height),n.theme){case"dark":s="#1a1a1a",l="#2a2a2a",r="#ffffff",h="#ffffff",m="#666666";break;case"colorful":s="#f0f8ff",l="#ffffff",r="#ff6b6b",h="#4ecdc4",m="#95e1d3";break;default:s="#f8f9fa",l="#ffffff",r="#333333",h="#333333",m="#cccccc"}o.fillStyle=s,o.fillRect(0,0,e.width,e.height),o.beginPath(),o.arc(c,a,i-10,0,2*Math.PI),o.fillStyle=l,o.fill(),o.strokeStyle=r,o.lineWidth=3,o.stroke(),o.strokeStyle=m,o.lineWidth=2;for(let e=0;e<12;e++){const t=(30*e-90)*Math.PI/180,n=i-30,s=i-20,l=c+n*Math.cos(t),d=a+n*Math.sin(t),r=c+s*Math.cos(t),h=a+s*Math.sin(t);o.beginPath(),o.moveTo(l,d),o.lineTo(r,h),o.stroke()}o.strokeStyle=m,o.lineWidth=1;for(let e=0;e<60;e++)if(e%5!=0){const t=(6*e-90)*Math.PI/180,n=i-25,s=i-20,l=c+n*Math.cos(t),d=a+n*Math.sin(t),r=c+s*Math.cos(t),h=a+s*Math.sin(t);o.beginPath(),o.moveTo(l,d),o.lineTo(r,h),o.stroke()}if(n.showNumbers){o.fillStyle=h,o.font="bold 20px Arial",o.textAlign="center",o.textBaseline="middle";for(let e=1;e<=12;e++){const t=(30*e-90)*Math.PI/180,n=i-45,s=c+n*Math.cos(t),l=a+n*Math.sin(t);o.fillText(e.toString(),s,l)}}const u=t.getHours(),g=t.getMinutes(),f=t.getSeconds();d(o,c,a,(u%12*30+.5*g-90)*Math.PI/180,.5*i,6,r),d(o,c,a,(6*g-90)*Math.PI/180,.7*i,4,r),n.showSeconds&&d(o,c,a,(6*f-90)*Math.PI/180,.75*i,2,"#e74c3c");o.beginPath(),o.arc(c,a,8,0,2*Math.PI),o.fillStyle=r,o.fill(),o.strokeStyle=l,o.lineWidth=2,o.stroke()}(t,m),o&&(o.style.display=n.showDigital?"block":"none",o.textContent=a),i&&(i.textContent=s)})}function h(){saveToLocalStorage("worldClocksSettings",n)}!function(){if(0===t.length){["Asia/Ho_Chi_Minh","Asia/Tokyo","Europe/London","America/New_York"].forEach(e=>{t.push({id:Date.now()+Math.random(),timezone:e,cityName:i[e]})}),s()}l()}(),c(),function(){e&&clearInterval(e);e=setInterval(()=>{r()},1e3)}(),setInterval(c,1e3),document.getElementById("add-clock-btn").addEventListener("click",function(){const e=document.getElementById("timezone-selector").value;a(e,i[e]||e)}),document.getElementById("timezone-selector").addEventListener("change",function(){c()}),document.getElementById("clear-all-clocks-btn").addEventListener("click",function(){t.length>0&&confirm("Bạn có chắc muốn xóa tất cả đồng hồ?")&&(t=[],s(),l(),showAlert("Đã xóa tất cả đồng hồ!","success"))}),document.getElementById("show-seconds").addEventListener("change",function(){n.showSeconds=this.checked,h(),r()}),document.getElementById("show-numbers").addEventListener("change",function(){n.showNumbers=this.checked,h(),r()}),document.getElementById("show-digital").addEventListener("change",function(){n.showDigital=this.checked,h(),r()}),document.getElementById("clock-theme").addEventListener("change",function(){n.theme=this.value,h(),r()}),document.querySelectorAll(".preset-city-btn").forEach(e=>{e.addEventListener("click",function(){a(this.dataset.timezone,this.dataset.city)})}),window.worldClocksRemove=function(e){t=t.filter(t=>t.id!==e),s(),l(),showAlert("Đã xóa đồng hồ!","success")},window.addEventListener("beforeunload",function(){e&&clearInterval(e)})});