document.addEventListener("DOMContentLoaded",function(){let e=loadFromLocalStorage("qrHistory")||[],t=null,n=null,o=null;function c(){return{width:parseInt(document.getElementById("qr-size").value),height:parseInt(document.getElementById("qr-size").value),colorDark:document.getElementById("qr-color").value,colorLight:document.getElementById("qr-bgcolor").value,correctLevel:QRCode.CorrectLevel[document.getElementById("qr-error-level").value]}}function l(){const l=function(){let e="";switch(document.querySelector('input[name="qr-type"]:checked').value){case"url":e=document.getElementById("url-input").value.trim(),!e||e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e);break;case"text":e=document.getElementById("text-input").value.trim();break;case"email":const t=document.getElementById("email-input").value.trim(),n=document.getElementById("email-subject").value.trim(),o=document.getElementById("email-body").value.trim();e=`mailto:${t}`,(n||o)&&(e+="?",n&&(e+=`subject=${encodeURIComponent(n)}`),n&&o&&(e+="&"),o&&(e+=`body=${encodeURIComponent(o)}`));break;case"phone":e=`tel:${document.getElementById("phone-input").value.trim()}`;break;case"vcard":const c=document.getElementById("vcard-firstname").value.trim(),l=document.getElementById("vcard-lastname").value.trim(),r=document.getElementById("vcard-org").value.trim(),d=document.getElementById("vcard-title").value.trim(),a=document.getElementById("vcard-phone").value.trim(),i=document.getElementById("vcard-email").value.trim(),s=document.getElementById("vcard-website").value.trim(),u=document.getElementById("vcard-address").value.trim();e="BEGIN:VCARD\n",e+="VERSION:3.0\n",(c||l)&&(e+=`N:${l};${c};;;\n`,e+=`FN:${c} ${l}\n`),r&&(e+=`ORG:${r}\n`),d&&(e+=`TITLE:${d}\n`),a&&(e+=`TEL:${a}\n`),i&&(e+=`EMAIL:${i}\n`),s&&(e+=`URL:${s}\n`),u&&(e+=`ADR:;;${u};;;;\n`),e+="END:VCARD"}return e}();if(!l)return void showAlert("Vui lòng nhập nội dung!","warning");const d=document.getElementById("qr-code-display");d.innerHTML="";try{const a=c();t=new QRCode(d,{text:l,width:a.width,height:a.height,colorDark:a.colorDark,colorLight:a.colorLight,correctLevel:a.correctLevel}),n={content:l,type:document.querySelector('input[name="qr-type"]:checked').value,settings:a,timestamp:(new Date).toISOString()},o&&setTimeout(()=>function(){const e=document.querySelector("#qr-code-display canvas");if(!e||!o)return;const t=e.getContext("2d"),n=.2*e.width,c=(e.width-n)/2,l=(e.height-n)/2;t.fillStyle="#ffffff",t.fillRect(c-5,l-5,n+10,n+10),t.drawImage(o,c,l,n,n)}(),100),document.getElementById("qr-display-container").style.display="block",function(t){const n=document.querySelector("#qr-code-display canvas");if(!n)return;const o={...t,imageData:n.toDataURL(),id:Date.now()};e.unshift(o),e.length>20&&(e=e.slice(0,20));saveToLocalStorage("qrHistory",e),r()}(n),"undefined"!=typeof gtag&&gtag("event","qr_generated",{event_category:"qr_generator",event_label:n.type}),showAlert("Đã tạo mã QR thành công!","success")}catch(e){showAlert("Lỗi khi tạo mã QR: "+e.message,"error")}}function r(){const t=document.getElementById("qr-history");0!==e.length?t.innerHTML=e.map((e,t)=>`\n            <div class="col-lg-2 col-md-3 col-sm-4 col-6">\n                <div class="qr-history-item">\n                    <img src="${e.imageData}" alt="QR Code">\n                    <div class="small text-muted">${e.type.toUpperCase()}</div>\n                    <div class="small text-truncate" title="${e.content}">\n                        ${e.content.length>20?e.content.substring(0,20)+"...":e.content}\n                    </div>\n                    <div class="btn-group btn-group-sm">\n                        <button class="btn btn-outline-primary" onclick="window.reloadQR(${t})">\n                            <i class="fas fa-redo"></i>\n                        </button>\n                        <button class="btn btn-outline-success" onclick="window.downloadHistoryQR(${t})">\n                            <i class="fas fa-download"></i>\n                        </button>\n                        <button class="btn btn-outline-danger" onclick="window.deleteHistoryQR(${t})">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `).join(""):t.innerHTML='<p class="text-muted text-center col-12">Chưa có lịch sử tạo mã QR</p>'}function d(){const e=document.querySelector('input[name="qr-type"]:checked').value;document.querySelectorAll(".input-section").forEach(e=>{e.style.display="none"}),document.getElementById(`input-${e}`).style.display="block"}function a(){const e=document.getElementById("qr-size").value;document.getElementById("size-value").textContent=e}r(),a(),window.reloadQR=function(t){const n=e[t];n&&(document.querySelector(`input[name="qr-type"][value="${n.type}"]`).checked=!0,d(),"url"===n.type?document.getElementById("url-input").value=n.content:"text"===n.type&&(document.getElementById("text-input").value=n.content),document.getElementById("qr-size").value=n.settings.width,document.getElementById("qr-color").value=n.settings.colorDark,document.getElementById("qr-bgcolor").value=n.settings.colorLight,a(),l(),window.scrollTo({top:0,behavior:"smooth"}))},window.downloadHistoryQR=function(t){const n=e[t];if(!n)return;const o=document.createElement("a");o.download=`qrcode-history-${Date.now()}.png`,o.href=n.imageData,o.click(),showAlert("Đã tải xuống!","success")},window.deleteHistoryQR=function(t){e.splice(t,1),saveToLocalStorage("qrHistory",e),r(),showAlert("Đã xóa khỏi lịch sử!","success")},document.getElementById("generate-qr-btn").addEventListener("click",l),document.getElementById("clear-qr-btn").addEventListener("click",function(){document.getElementById("qr-code-display").innerHTML="",document.getElementById("qr-display-container").style.display="none",t=null,n=null}),document.getElementById("download-png-btn").addEventListener("click",function(){const e=document.querySelector("#qr-code-display canvas");e?e.toBlob(function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.download=`qrcode-${Date.now()}.png`,n.href=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),showAlert("Đã tải xuống PNG!","success")}):showAlert("Chưa có mã QR để tải!","warning")}),document.getElementById("download-svg-btn").addEventListener("click",function(){if(!document.querySelector("#qr-code-display canvas"))return void showAlert("Chưa có mã QR để tải!","warning");const e=c(),t=e.width,o=n.content,l=qrcode(0,document.getElementById("qr-error-level").value);l.addData(o),l.make();const r=l.getModuleCount(),d=t/r;let a=`<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${t}">`;a+=`<rect width="100%" height="100%" fill="${e.colorLight}"/>`;for(let t=0;t<r;t++)for(let n=0;n<r;n++)if(l.isDark(t,n)){a+=`<rect x="${n*d}" y="${t*d}" width="${d}" height="${d}" fill="${e.colorDark}"/>`}a+="</svg>";const i=new Blob([a],{type:"image/svg+xml"}),s=URL.createObjectURL(i),u=document.createElement("a");u.download=`qrcode-${Date.now()}.svg`,u.href=s,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(s),showAlert("Đã tải xuống SVG!","success")}),document.getElementById("batch-generate-btn").addEventListener("click",function(){const e=document.getElementById("batch-input").value.trim();if(!e)return void showAlert("Vui lòng nhập danh sách URL/văn bản!","warning");const t=e.split("\n").filter(e=>e.trim());if(0===t.length)return void showAlert("Không có mục nào để tạo!","warning");if(t.length>50)return void showAlert("Tối đa 50 mã QR mỗi lần!","warning");const n=document.getElementById("batch-results");n.innerHTML="";const o=c();t.forEach((e,t)=>{const c=document.createElement("div");c.className="col-md-3 col-sm-4 col-6";const l=document.createElement("div");l.className="batch-qr-item";const r=document.createElement("div");r.id=`batch-qr-${t}`;try{new QRCode(r,{text:e,width:200,height:200,colorDark:o.colorDark,colorLight:o.colorLight,correctLevel:o.correctLevel}),l.appendChild(r);const d=document.createElement("div");d.className="small text-muted mt-2",d.textContent=e.length>30?e.substring(0,30)+"...":e,l.appendChild(d);const a=document.createElement("button");a.className="btn btn-sm btn-primary mt-2",a.innerHTML='<i class="fas fa-download"></i> PNG',a.onclick=function(){r.querySelector("canvas").toBlob(function(e){const n=URL.createObjectURL(e),o=document.createElement("a");o.download=`qrcode-${t+1}.png`,o.href=n,o.click(),URL.revokeObjectURL(n)})},l.appendChild(a),c.appendChild(l),n.appendChild(c)}catch(t){console.error("Error generating QR for:",e,t)}}),new bootstrap.Modal(document.getElementById("batchModal")).show(),showAlert(`Đã tạo ${t.length} mã QR!`,"success"),"undefined"!=typeof gtag&&gtag("event","batch_qr_generated",{event_category:"qr_generator",event_label:"batch",value:t.length})}),document.getElementById("download-all-btn").addEventListener("click",function(){const e=document.querySelectorAll("#batch-results canvas");0!==e.length?(e.forEach((e,t)=>{setTimeout(()=>{e.toBlob(function(e){const n=URL.createObjectURL(e),o=document.createElement("a");o.download=`qrcode-batch-${t+1}.png`,o.href=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)})},200*t)}),showAlert(`Đang tải ${e.length} mã QR...`,"info")):showAlert("Không có mã QR nào để tải!","warning")}),document.getElementById("clear-history-btn").addEventListener("click",function(){0!==e.length&&confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")&&(e=[],saveToLocalStorage("qrHistory",e),r(),showAlert("Đã xóa lịch sử!","success"))}),document.getElementById("reset-customization-btn").addEventListener("click",function(){document.getElementById("qr-size").value=256,document.getElementById("qr-color").value="#000000",document.getElementById("qr-bgcolor").value="#ffffff",document.getElementById("qr-error-level").value="M",document.getElementById("qr-logo").value="",o=null,a(),t&&l()}),document.querySelectorAll('input[name="qr-type"]').forEach(e=>{e.addEventListener("change",d)}),document.getElementById("qr-size").addEventListener("input",a),["qr-size","qr-color","qr-bgcolor","qr-error-level"].forEach(e=>{document.getElementById(e).addEventListener("change",function(){t&&l()})}),document.querySelectorAll(".color-preset").forEach(e=>{e.addEventListener("click",function(){document.getElementById("qr-color").value=this.dataset.fg,document.getElementById("qr-bgcolor").value=this.dataset.bg,t&&l()})}),document.getElementById("qr-logo").addEventListener("change",function(e){const n=e.target.files[0];if(n){const e=new FileReader;e.onload=function(e){const n=new Image;n.onload=function(){o=n,t&&l()},n.src=e.target.result},e.readAsDataURL(n)}}),document.addEventListener("keypress",function(e){"Enter"===e.key&&e.target.matches('input[type="text"], input[type="url"], input[type="email"], input[type="tel"]')&&l()})});