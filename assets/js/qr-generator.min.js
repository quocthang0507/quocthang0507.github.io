document.addEventListener("DOMContentLoaded",function(){const e=200;let t=loadFromLocalStorage("qrHistory")||[],n=null,o=null,r=null,c=null,a=null;function l(e=!1){const t=parseInt(document.getElementById("qr-size").value),n=e?Math.min(t,256):t;return{width:n,height:n,colorDark:document.getElementById("qr-color").value,colorLight:document.getElementById("qr-bgcolor").value,correctLevel:document.getElementById("qr-error-level").value}}function d(){return{dotsType:document.getElementById("qr-pattern")?.value||"square",cornerSquareType:document.getElementById("qr-corner-square")?.value||"square",cornerDotType:document.getElementById("qr-corner-dot")?.value||"dot"}}async function i(){const e=function(){let e="";switch(document.querySelector('input[name="qr-type"]:checked').value){case"url":e=document.getElementById("url-input").value.trim(),!e||e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e);break;case"text":e=document.getElementById("text-input").value.trim();break;case"email":const t=document.getElementById("email-input").value.trim(),n=document.getElementById("email-subject").value.trim(),o=document.getElementById("email-body").value.trim();e=`mailto:${t}`,(n||o)&&(e+="?",n&&(e+=`subject=${encodeURIComponent(n)}`),n&&o&&(e+="&"),o&&(e+=`body=${encodeURIComponent(o)}`));break;case"phone":e=`tel:${document.getElementById("phone-input").value.trim()}`;break;case"vcard":const r=document.getElementById("vcard-firstname").value.trim(),c=document.getElementById("vcard-lastname").value.trim(),a=document.getElementById("vcard-org").value.trim(),l=document.getElementById("vcard-title").value.trim(),d=document.getElementById("vcard-phone").value.trim(),i=document.getElementById("vcard-email").value.trim(),s=document.getElementById("vcard-website").value.trim(),u=document.getElementById("vcard-address").value.trim();e="BEGIN:VCARD\n",e+="VERSION:3.0\n",(r||c)&&(e+=`N:${c};${r};;;\n`,e+=`FN:${r} ${c}\n`),a&&(e+=`ORG:${a}\n`),l&&(e+=`TITLE:${l}\n`),d&&(e+=`TEL:${d}\n`),i&&(e+=`EMAIL:${i}\n`),s&&(e+=`URL:${s}\n`),u&&(e+=`ADR:;;${u};;;;\n`),e+="END:VCARD"}return e}();if(!e)return void showAlert("Vui lòng nhập nội dung!","warning");const i=document.getElementById("qr-code-display");i.innerHTML="";try{const u=l(!0),m=d();"undefined"!=typeof QRCodeStyling?(r=new QRCodeStyling({width:u.width,height:u.height,type:"canvas",data:e,qrOptions:{errorCorrectionLevel:u.correctLevel},dotsOptions:{color:u.colorDark,type:m.dotsType},backgroundOptions:{color:u.colorLight},cornersSquareOptions:{color:u.colorDark,type:m.cornerSquareType},cornersDotOptions:{color:u.colorDark,type:m.cornerDotType},image:a||void 0,imageOptions:{crossOrigin:"anonymous",margin:5,imageSize:.2,hideBackgroundDots:!0}}),r.append(i),n=r):n=new QRCode(i,{text:e,width:u.width,height:u.height,colorDark:u.colorDark,colorLight:u.colorLight,correctLevel:QRCode.CorrectLevel[u.correctLevel]}),o={content:e,type:document.querySelector('input[name="qr-type"]:checked').value,settings:u,style:m,timestamp:(new Date).toISOString()},document.getElementById("qr-display-container").style.display="block",!r&&c&&await async function(e){if(!c)return;const t=await function(e,t=1500){const n=performance.now();return new Promise((o,r)=>{function c(){const a=document.querySelector(e);a?o(a):performance.now()-n>t?r(new Error("QR canvas not found")):requestAnimationFrame(c)}c()})}("#qr-code-display canvas"),n=t.getContext("2d");if(!n)return;await async function(e){if(!e)return;if(e.decode)try{return void await e.decode()}catch(e){}if(e.complete&&e.naturalWidth>0)return;await new Promise((t,n)=>{e.onload=()=>t(),e.onerror=()=>n(new Error("Logo image failed to load"))})}(c);const o=e||l(),r=Math.min(t.width,t.height),a=Math.round(.2*r),d=Math.max(4,Math.round(.02*r)),i=c.naturalWidth&&c.naturalHeight?c.naturalWidth/c.naturalHeight:1;let s=a,u=a;i>1?u=Math.round(a/i):s=Math.round(a*i);const m=Math.round((t.width-s)/2),g=Math.round((t.height-u)/2);n.save(),n.fillStyle=o.colorLight||"#ffffff",n.fillRect(Math.round((t.width-a)/2)-d,Math.round((t.height-a)/2)-d,a+2*d,a+2*d),n.restore(),n.drawImage(c,m,g,s,u);const h=document.querySelector("#qr-code-display img");if(h)try{h.src=t.toDataURL("image/png")}catch(e){}}({colorLight:u.colorLight}),function(e){if(r&&"function"==typeof r.getRawData)return void r.getRawData("png").then(n=>{const o=new FileReader;o.onloadend=function(){const n={...e,imageData:o.result,id:Date.now()};t.unshift(n),t.length>20&&(t=t.slice(0,20)),saveToLocalStorage("qrHistory",t),s()},o.readAsDataURL(n)}).catch(()=>{const n=document.querySelector("#qr-code-display canvas");if(!n)return;const o={...e,imageData:n.toDataURL(),id:Date.now()};t.unshift(o),t.length>20&&(t=t.slice(0,20)),saveToLocalStorage("qrHistory",t),s()});const n=document.querySelector("#qr-code-display canvas");if(!n)return;const o={...e,imageData:n.toDataURL(),id:Date.now()};t.unshift(o),t.length>20&&(t=t.slice(0,20));saveToLocalStorage("qrHistory",t),s()}(o),"undefined"!=typeof gtag&&gtag("event","qr_generated",{event_category:"qr_generator",event_label:o.type}),showAlert("Đã tạo mã QR thành công!","success")}catch(e){showAlert("Lỗi khi tạo mã QR: "+e.message,"error")}}function s(){const e=document.getElementById("qr-history");0!==t.length?e.innerHTML=t.map((e,t)=>`\n            <div class="col-lg-2 col-md-3 col-sm-4 col-6">\n                <div class="qr-history-item">\n                    <img src="${e.imageData}" alt="QR Code">\n                    <div class="small text-muted">${e.type.toUpperCase()}</div>\n                    <div class="small text-truncate" title="${e.content}">\n                        ${e.content.length>20?e.content.substring(0,20)+"...":e.content}\n                    </div>\n                    <div class="btn-group btn-group-sm">\n                        <button class="btn btn-outline-primary" onclick="window.reloadQR(${t})">\n                            <i class="fas fa-redo"></i>\n                        </button>\n                        <button class="btn btn-outline-success" onclick="window.downloadHistoryQR(${t})">\n                            <i class="fas fa-download"></i>\n                        </button>\n                        <button class="btn btn-outline-danger" onclick="window.deleteHistoryQR(${t})">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `).join(""):e.innerHTML='<p class="text-muted text-center col-12">Chưa có lịch sử tạo mã QR</p>'}function u(){const e=document.querySelector('input[name="qr-type"]:checked').value;document.querySelectorAll(".input-section").forEach(e=>{e.style.display="none"}),document.getElementById(`input-${e}`).style.display="block"}function m(){const e=document.getElementById("qr-size").value;document.getElementById("size-value").textContent=e}s(),m(),window.reloadQR=function(e){const n=t[e];n&&(document.querySelector(`input[name="qr-type"][value="${n.type}"]`).checked=!0,u(),"url"===n.type?document.getElementById("url-input").value=n.content:"text"===n.type&&(document.getElementById("text-input").value=n.content),document.getElementById("qr-size").value=n.settings.width,document.getElementById("qr-color").value=n.settings.colorDark,document.getElementById("qr-bgcolor").value=n.settings.colorLight,m(),i(),window.scrollTo({top:0,behavior:"smooth"}))},window.downloadHistoryQR=function(e){const n=t[e];if(!n)return;const o=document.createElement("a");o.download=`qrcode-history-${Date.now()}.png`,o.href=n.imageData,o.click(),showAlert("Đã tải xuống!","success")},window.deleteHistoryQR=function(e){t.splice(e,1),saveToLocalStorage("qrHistory",t),s(),showAlert("Đã xóa khỏi lịch sử!","success")},document.getElementById("generate-qr-btn").addEventListener("click",i),document.getElementById("clear-qr-btn").addEventListener("click",function(){document.getElementById("qr-code-display").innerHTML="",document.getElementById("qr-display-container").style.display="none",n=null,r=null,o=null}),document.getElementById("download-png-btn").addEventListener("click",function(){if(!o)return void showAlert("Chưa có mã QR để tải!","warning");const e=l(!1),t=d();if("undefined"!=typeof QRCodeStyling){new QRCodeStyling({width:512,height:512,type:"canvas",data:o.content,qrOptions:{errorCorrectionLevel:e.correctLevel},dotsOptions:{color:e.colorDark,type:t.dotsType},backgroundOptions:{color:e.colorLight},cornersSquareOptions:{color:e.colorDark,type:t.cornerSquareType},cornersDotOptions:{color:e.colorDark,type:t.cornerDotType},image:a||void 0,imageOptions:{crossOrigin:"anonymous",margin:5,imageSize:.2,hideBackgroundDots:!0}}).download({name:`qrcode-${Date.now()}`,extension:"png"}),showAlert("Đã tải xuống PNG chất lượng cao!","success")}else{const e=document.querySelector("#qr-code-display canvas");if(!e)return void showAlert("Chưa có mã QR để tải!","warning");e.toBlob(function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.download=`qrcode-${Date.now()}.png`,n.href=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),showAlert("Đã tải xuống PNG!","success")})}}),document.getElementById("download-svg-btn").addEventListener("click",function(){if(r&&"function"==typeof r.download)return r.download({name:`qrcode-${Date.now()}`,extension:"svg"}),void showAlert("Đã tải xuống SVG!","success");if(!document.querySelector("#qr-code-display canvas"))return void showAlert("Chưa có mã QR để tải!","warning");const e=l(),t=e.width,n=o.content,c=qrcode(0,document.getElementById("qr-error-level").value);c.addData(n),c.make();const d=c.getModuleCount(),i=t/d;let s=`<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${t}">`;s+=`<rect width="100%" height="100%" fill="${e.colorLight}"/>`;for(let t=0;t<d;t++)for(let n=0;n<d;n++)if(c.isDark(t,n)){s+=`<rect x="${n*i}" y="${t*i}" width="${i}" height="${i}" fill="${e.colorDark}"/>`}if(a){const n=.2*t,o=Math.max(4,.02*t),r=(t-n)/2,c=(t-n)/2;s+=`<rect x="${r-o}" y="${c-o}" width="${n+2*o}" height="${n+2*o}" fill="${e.colorLight}"/>`,s+=`<image x="${r}" y="${c}" width="${n}" height="${n}" href="${a}" preserveAspectRatio="xMidYMid meet"/>`}s+="</svg>";const u=new Blob([s],{type:"image/svg+xml"}),m=URL.createObjectURL(u),g=document.createElement("a");g.download=`qrcode-${Date.now()}.svg`,g.href=m,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(m),showAlert("Đã tải xuống SVG!","success")}),document.getElementById("batch-generate-btn").addEventListener("click",function(){const e=document.getElementById("batch-input").value.trim();if(!e)return void showAlert("Vui lòng nhập danh sách URL/văn bản!","warning");const t=e.split("\n").filter(e=>e.trim());if(0===t.length)return void showAlert("Không có mục nào để tạo!","warning");if(t.length>50)return void showAlert("Tối đa 50 mã QR mỗi lần!","warning");const n=document.getElementById("batch-results");n.innerHTML="";const o=l();t.forEach((e,t)=>{const r=document.createElement("div");r.className="col-md-3 col-sm-4 col-6";const c=document.createElement("div");c.className="batch-qr-item";const a=document.createElement("div");a.id=`batch-qr-${t}`;try{new QRCode(a,{text:e,width:200,height:200,colorDark:o.colorDark,colorLight:o.colorLight,correctLevel:o.correctLevel}),c.appendChild(a);const l=document.createElement("div");l.className="small text-muted mt-2",l.textContent=e.length>30?e.substring(0,30)+"...":e,c.appendChild(l);const d=document.createElement("button");d.className="btn btn-sm btn-primary mt-2",d.innerHTML='<i class="fas fa-download"></i> PNG',d.onclick=function(){a.querySelector("canvas").toBlob(function(e){const n=URL.createObjectURL(e),o=document.createElement("a");o.download=`qrcode-${t+1}.png`,o.href=n,o.click(),URL.revokeObjectURL(n)})},c.appendChild(d),r.appendChild(c),n.appendChild(r)}catch(t){console.error("Error generating QR for:",e,t)}}),new bootstrap.Modal(document.getElementById("batchModal")).show(),showAlert(`Đã tạo ${t.length} mã QR!`,"success"),"undefined"!=typeof gtag&&gtag("event","batch_qr_generated",{event_category:"qr_generator",event_label:"batch",value:t.length})}),document.getElementById("download-all-btn").addEventListener("click",function(){const e=document.querySelectorAll("#batch-results canvas");0!==e.length?(e.forEach((e,t)=>{setTimeout(()=>{e.toBlob(function(e){const n=URL.createObjectURL(e),o=document.createElement("a");o.download=`qrcode-batch-${t+1}.png`,o.href=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)})},200*t)}),showAlert(`Đang tải ${e.length} mã QR...`,"info")):showAlert("Không có mã QR nào để tải!","warning")}),document.getElementById("clear-history-btn").addEventListener("click",function(){0!==t.length&&confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")&&(t=[],saveToLocalStorage("qrHistory",t),s(),showAlert("Đã xóa lịch sử!","success"))}),document.getElementById("reset-customization-btn").addEventListener("click",function(){document.getElementById("qr-size").value=256,document.getElementById("qr-color").value="#000000",document.getElementById("qr-bgcolor").value="#ffffff",document.getElementById("qr-error-level").value="M",document.getElementById("qr-pattern")&&(document.getElementById("qr-pattern").value="square"),document.getElementById("qr-corner-square")&&(document.getElementById("qr-corner-square").value="square"),document.getElementById("qr-corner-dot")&&(document.getElementById("qr-corner-dot").value="dot"),document.getElementById("qr-logo").value="",c=null,a=null,m(),n&&i()}),document.querySelectorAll('input[name="qr-type"]').forEach(e=>{e.addEventListener("change",u)}),document.getElementById("qr-size").addEventListener("input",m),["qr-size","qr-color","qr-bgcolor","qr-error-level","qr-pattern","qr-corner-square","qr-corner-dot"].forEach(e=>{document.getElementById(e).addEventListener("change",function(){n&&i()})}),document.querySelectorAll(".color-preset").forEach(e=>{e.addEventListener("click",function(){document.getElementById("qr-color").value=this.dataset.fg,document.getElementById("qr-bgcolor").value=this.dataset.bg,n&&i()})}),document.getElementById("qr-logo").addEventListener("change",function(t){const o=t.target.files[0];if(o){const t=new FileReader;t.onload=function(t){const o=new Image;o.onload=function(){const t=document.createElement("canvas"),r=t.getContext("2d");let l=o.width,d=o.height;if(l>e||d>e){const t=Math.min(e/l,e/d);l=Math.round(l*t),d=Math.round(d*t)}t.width=l,t.height=d,r.drawImage(o,0,0,l,d);const s=new Image;s.onload=function(){c=s,a=t.toDataURL("image/png"),n&&i()},s.src=t.toDataURL("image/png")},o.src=t.target.result},t.readAsDataURL(o)}else c=null,a=null}),document.addEventListener("keypress",function(e){"Enter"===e.key&&e.target.matches('input[type="text"], input[type="url"], input[type="email"], input[type="tel"]')&&i()})});