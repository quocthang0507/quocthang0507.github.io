document.addEventListener("DOMContentLoaded",function(){let e=!0,t=!0,a=(new Date).getMonth(),n=(new Date).getFullYear(),d=0,l=0,s=null,o=!1,i=0,c=0,r=null,u=!1;function m(){const a=new Date,n=a.getHours(),d=a.getMinutes(),l=a.getSeconds();let s;if(e)s=`${g(n)}:${g(d)}`,t&&(s+=`:${g(l)}`);else{const e=n>=12?"PM":"AM";s=`${g(0===n?12:n>12?n-12:n)}:${g(d)}`,t&&(s+=`:${g(l)}`),s+=` ${e}`}document.getElementById("digital-clock").textContent=s;document.getElementById("current-date").textContent=a.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function g(e){return e.toString().padStart(2,"0")}function y(){const e=new Date(n,a,1),t=new Date(n,a+1,0),d=new Date,l=`month.${a+1}`,s=window.t?window.t(l):`Tháng ${a+1}`;document.getElementById("calendar-title").textContent=`${s} ${n}`;let o='<table class="calendar-table">';o+=`<tr>${["cal.sunday","cal.monday","cal.tuesday","cal.wednesday","cal.thursday","cal.friday","cal.saturday"].map(e=>window.t?window.t(e):e.split(".")[1]).map(e=>`<th>${e}</th>`).join("")}</tr>`;let i=1;const c=e.getDay();for(let e=0;e<6;e++){o+="<tr>";for(let l=0;l<7;l++)if(0===e&&l<c){o+=`<td class="other-month">${new Date(n,a,0).getDate()-(c-l-1)}</td>`}else if(i>t.getDate()){o+=`<td class="other-month">${i-t.getDate()}</td>`,i++}else{const e=n===d.getFullYear()&&a===d.getMonth()&&i===d.getDate()?"today":"";let t="";if(window.LunarCalendar)try{const e=window.LunarCalendar.solarToLunar(i,a+1,n);e&&(t=`<small class="lunar-date mt-auto">${e.day}/${e.month}${e.isLeap?"*":""}</small>`)}catch(e){}o+=`<td class="${e} calendar-day" data-date="${i}" data-month="${a+1}" data-year="${n}">\n                        <a href="#" class="calendar-day-link d-flex flex-column align-items-center p-1" aria-label="${i}/${a+1}/${n}">\n                            <div class="solar-date">${i}</div>\n                            ${t}\n                        </a>\n                    </td>`,i++}if(o+="</tr>",i>t.getDate())break}o+="</table>",document.getElementById("calendar-display").innerHTML=o,document.querySelectorAll(".calendar-day-link").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.closest(".calendar-day");if(!t)return;v(parseInt(t.dataset.date),parseInt(t.dataset.month),parseInt(t.dataset.year))})})}function p(){const e=l+(o?Date.now()-d:0),t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),n=Math.floor(e%6e4/1e3),s=e%1e3;var i;document.getElementById("stopwatch-display").textContent=`${g(t)}:${g(a)}:${g(n)}.${i=s,i.toString().padStart(3,"0")}`}function h(){if(c>0){const e=Math.floor(c/60),t=c%60;document.getElementById("timer-display").textContent=`${g(e)}:${g(t)}`,c--}else if(clearInterval(r),u=!1,document.getElementById("start-timer").disabled=!1,document.getElementById("pause-timer").disabled=!0,showAlert("Timer đã kết thúc!","warning"),"speechSynthesis"in window){const e=new SpeechSynthesisUtterance("Timer đã kết thúc");e.lang="vi-VN",speechSynthesis.speak(e)}}m(),y(),function(){const e=new Date;document.getElementById("timezone").textContent=Intl.DateTimeFormat().resolvedOptions().timeZone;const t=new Date(e.getFullYear(),0,0),a=e-t,n=864e5,d=Math.floor(a/n);document.getElementById("day-of-year").textContent=d;const l=new Date(e.getFullYear(),0,1),s=Math.floor((e-l)/n),o=Math.ceil((s+l.getDay()+1)/7);document.getElementById("week-of-year").textContent=o}(),setInterval(m,1e3),document.getElementById("toggle-format").addEventListener("click",function(){e=!e,m(),"undefined"!=typeof gtag&&gtag("event","clock_format_change",{event_category:"clock_tools",event_label:e?"24_hour":"12_hour"})}),document.getElementById("toggle-seconds").addEventListener("click",function(){t=!t,m(),"undefined"!=typeof gtag&&gtag("event","clock_seconds_toggle",{event_category:"clock_tools",event_label:t?"show_seconds":"hide_seconds"})}),document.getElementById("prev-month").addEventListener("click",function(){a--,a<0&&(a=11,n--),y()}),document.getElementById("next-month").addEventListener("click",function(){a++,a>11&&(a=0,n++),y()}),document.getElementById("today-btn").addEventListener("click",function(){const e=new Date;a=e.getMonth(),n=e.getFullYear(),y()}),document.getElementById("start-stopwatch").addEventListener("click",function(){o||(d=Date.now(),o=!0,s=setInterval(p,10),this.disabled=!0,document.getElementById("pause-stopwatch").disabled=!1,"undefined"!=typeof gtag&&gtag("event","stopwatch_start",{event_category:"clock_tools",event_label:"stopwatch_interaction"}))}),document.getElementById("pause-stopwatch").addEventListener("click",function(){o&&(l+=Date.now()-d,o=!1,clearInterval(s),document.getElementById("start-stopwatch").disabled=!1,this.disabled=!0,"undefined"!=typeof gtag&&gtag("event","stopwatch_pause",{event_category:"clock_tools",event_label:"stopwatch_interaction",elapsed_time:Math.round(l/1e3)}))}),document.getElementById("reset-stopwatch").addEventListener("click",function(){const e=l;l=0,o=!1,clearInterval(s),document.getElementById("start-stopwatch").disabled=!1,document.getElementById("pause-stopwatch").disabled=!0,p(),"undefined"!=typeof gtag&&gtag("event","stopwatch_reset",{event_category:"clock_tools",event_label:"stopwatch_interaction",final_time:Math.round(e/1e3)})}),document.getElementById("start-timer").addEventListener("click",function(){if(!u){const e=parseInt(document.getElementById("timer-minutes").value)||0,t=parseInt(document.getElementById("timer-seconds").value)||0;i=60*e+t,c=i,c>0?(u=!0,r=setInterval(h,1e3),this.disabled=!0,document.getElementById("pause-timer").disabled=!1,"undefined"!=typeof gtag&&gtag("event","timer_start",{event_category:"clock_tools",event_label:"timer_interaction",timer_duration:i})):showAlert("Vui lòng nhập thời gian hợp lệ!","danger")}}),document.getElementById("pause-timer").addEventListener("click",function(){u&&(u=!1,clearInterval(r),document.getElementById("start-timer").disabled=!1,this.disabled=!0)}),document.getElementById("reset-timer").addEventListener("click",function(){u=!1,clearInterval(r);const e=parseInt(document.getElementById("timer-minutes").value)||5,t=parseInt(document.getElementById("timer-seconds").value)||0;c=60*e+t,h(),document.getElementById("start-timer").disabled=!1,document.getElementById("pause-timer").disabled=!0}),p();const b=parseInt(document.getElementById("timer-minutes").value)||5,f=parseInt(document.getElementById("timer-seconds").value)||0;function v(e,t,a){const n=window.t||((e,t)=>t||e),d=new Date(a,t-1,e),l=["day.sunday","day.monday","day.tuesday","day.wednesday","day.thursday","day.friday","day.saturday"],s=n(l[d.getDay()],l[d.getDay()]),o=d-new Date(a,0,0),i=864e5,c=Math.floor(o/i),r=new Date(a,0,1),u=Math.floor((d-r)/i),m=Math.ceil((u+r.getDay()+1)/7);let g=null,y="",p="",h="",b=!1;if(window.LunarCalendar)try{g=window.LunarCalendar.solarToLunar(e,t,a),g&&(y=window.LunarCalendar.getZodiacAnimal(g.year)||"",p=window.LunarCalendar.getCanChi(g.year)||"",h=window.LunarCalendar.getLunarMonthName(g.month,g.isLeap)||"",b=!0)}catch(e){b=!1}let f=null;window.VietnamHolidays&&(f=window.VietnamHolidays.getHoliday(e,t,a));let w=document.getElementById("dateDetailsModal");w||(document.body.insertAdjacentHTML("beforeend",`\n            <div class="modal fade" id="dateDetailsModal" tabindex="-1" aria-hidden="true">\n              <div class="modal-dialog modal-lg modal-dialog-centered">\n                <div class="modal-content date-modal">\n                  <div class="modal-header date-modal-header">\n                    <h5 class="modal-title" id="dateDetailsTitle"></h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                  </div>\n                  <div class="modal-body" id="dateDetailsBody"></div>\n                  <div class="modal-footer flex-wrap gap-2">\n                    <div class="btn-group me-auto" role="group" aria-label="Navigation">\n                      <button type="button" class="btn btn-outline-primary" id="datePrevBtn"><i class="fas fa-chevron-left"></i></button>\n                      <button type="button" class="btn btn-outline-secondary" id="dateTodayBtn"><i class="fas fa-calendar-day"></i></button>\n                      <button type="button" class="btn btn-outline-primary" id="dateNextBtn"><i class="fas fa-chevron-right"></i></button>\n                    </div>\n                    <button type="button" class="btn btn-outline-success" id="dateCopyBtn"><i class="fas fa-copy"></i> ${n("lunar.copy","Sao chép")}</button>\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${n("lunar.close","Đóng")}</button>\n                  </div>\n                </div>\n              </div>\n            </div>`),w=document.getElementById("dateDetailsModal"));w.querySelector("#dateDetailsTitle").textContent=`${n("lunar.details_title","Chi tiết ngày")} ${e}/${t}/${a}`;let $="";$=b?`\n            <div class="col-md-6">\n                <div class="date-card lunar-card p-3 h-100">\n                    <h6 class="text-muted mb-2"><i class="fas fa-moon"></i> ${n("lunar.lunar","Âm lịch")}</h6>\n                    <div class="display-6 fw-bold mb-1">${g.day}</div>\n                    <div class="fs-6">${h}</div>\n                    <div class="small text-secondary mt-1">${n("lunar.year","Năm")}: ${g.year} (${p})</div>\n                    <div class="d-flex flex-wrap gap-2 mt-3">\n                        <span class="badge bg-info-subtle text-info-emphasis border date-badge">${y}</span>\n                        <span class="badge bg-warning-subtle text-warning-emphasis border date-badge">${g.isLeap?n("lunar.month_leap","Tháng nhuận"):n("lunar.month_normal","Tháng thường")}</span>\n                    </div>\n                </div>\n            </div>`:`<div class="col-md-6"><div class="alert alert-warning mb-0">${n("lunar.unavailable","Không có dữ liệu âm lịch")}</div></div>`;let _="";if(f){const e=f.is_public_holiday?'<i class="fas fa-star text-danger"></i>':'<i class="fas fa-calendar-alt text-info"></i>',t=f.is_public_holiday?'<span class="badge bg-danger-subtle text-danger-emphasis border date-badge"><i class="fas fa-flag"></i> Ngày lễ chính thức</span>':'<span class="badge bg-info-subtle text-info-emphasis border date-badge">Ngày kỷ niệm</span>',a="lunar"===f.type?'<span class="badge bg-secondary-subtle text-secondary-emphasis border date-badge"><i class="fas fa-moon"></i> Âm lịch</span>':'<span class="badge bg-primary-subtle text-primary-emphasis border date-badge"><i class="fas fa-sun"></i> Dương lịch</span>';_=`\n            <div class="col-12 mt-3">\n                <div class="alert alert-${f.is_public_holiday?"danger":"info"} mb-0">\n                    <h6 class="alert-heading mb-2">${e} Ngày lễ</h6>\n                    <p class="mb-2 fw-bold">${f.name}</p>\n                    ${f.name_en?`<p class="mb-2 small text-muted">${f.name_en}</p>`:""}\n                    ${f.description?`<p class="mb-2 small">${f.description}</p>`:""}\n                    <div class="d-flex flex-wrap gap-2 mt-2">\n                        ${t}\n                        ${a}\n                        ${f.duration_days?`<span class="badge bg-success-subtle text-success-emphasis border date-badge">Nghỉ: ${f.duration_days} ngày</span>`:""}\n                    </div>\n                </div>\n            </div>`}const I=`\n        <div class="row g-3 align-items-stretch">\n            <div class="col-md-6">\n                <div class="date-card solar-card p-3 h-100">\n                    <h6 class="text-muted mb-2"><i class="fas fa-sun"></i> ${n("lunar.solar","Dương lịch")}</h6>\n                    <div class="display-6 fw-bold mb-1">${e}</div>\n                    <div class="fs-5">${s}</div>\n                    <div class="small text-secondary mt-1">${n("lunar.full_date","Ngày")} ${e} / ${t} / ${a}</div>\n                    <div class="d-flex flex-wrap gap-2 mt-3">\n                        <span class="badge bg-primary-subtle text-primary-emphasis border date-badge">${n("lunar.day_of_year","Ngày trong năm")}: ${c}</span>\n                        <span class="badge bg-secondary-subtle text-secondary-emphasis border date-badge">${n("lunar.week_of_year","Tuần")}: ${m}</span>\n                    </div>\n                </div>\n            </div>\n            ${$}\n            ${_}\n        </div>`;w.querySelector("#dateDetailsBody").innerHTML=I,w.dataset.day=e,w.dataset.month=t,w.dataset.year=a,w.querySelector("#datePrevBtn").onclick=()=>{const n=new Date(a,t-1,e);n.setDate(n.getDate()-1),v(n.getDate(),n.getMonth()+1,n.getFullYear())},w.querySelector("#dateNextBtn").onclick=()=>{const n=new Date(a,t-1,e);n.setDate(n.getDate()+1),v(n.getDate(),n.getMonth()+1,n.getFullYear())},w.querySelector("#dateTodayBtn").onclick=()=>{const e=new Date;v(e.getDate(),e.getMonth()+1,e.getFullYear())},w.querySelector("#dateCopyBtn").onclick=()=>{const d=[`${n("lunar.solar","Dương lịch")}: ${e}/${t}/${a} (${s})`,b?`${n("lunar.lunar","Âm lịch")}: ${g.day} ${h} ${g.year} (${p})`:"",b?`${n("lunar.zodiac","Con giáp")}: ${y}`:"",`${n("lunar.day_of_year","Ngày trong năm")}: ${c}`,`${n("lunar.week_of_year","Tuần")}: ${m}`].filter(Boolean).join("\n");navigator.clipboard&&navigator.clipboard.writeText(d).then(()=>{showAlert(n("lunar.copied","Đã sao chép!"),"success")})};bootstrap.Modal.getOrCreateInstance(w).show()}c=60*b+f,h(),window.addEventListener("languageChanged",function(){y()}),window.updateCalendar=y,window.closeDateModal=function(){const e=document.getElementById("dateDetailsModal");e&&e.remove()}});