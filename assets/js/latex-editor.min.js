document.addEventListener("DOMContentLoaded",function(){const e=(e,t)=>{try{if(window.translationSystem&&"function"==typeof window.translationSystem.t)return window.translationSystem.t(e,t??e)}catch(e){}return t??e};let t=function(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return console.error("Failed to load from localStorage:",e),null}}("latexHistory")||[];const n=document.getElementById("latex-input"),a=document.getElementById("latex-output");let o=null;function c(){const t=n.value.trim();t?(a.innerHTML=`$$${t}$$`,"undefined"!=typeof MathJax&&(MathJax.typesetClear([a]),MathJax.typesetPromise([a]).catch(function(t){a.innerHTML=`<span class="text-danger">${e("latex.error_syntax","Lỗi cú pháp")}: ${t.message}</span>`}))):a.innerHTML=`<span class="text-muted">${e("latex.preview_placeholder","Nhập mã LaTeX để xem trước...")}</span>`}function l(){const a=document.getElementById("latex-history");0!==t.length?(a.innerHTML="",t.forEach((o,i)=>{const s=document.createElement("div");s.className="col-md-4 col-lg-3";const d=document.createElement("div");d.className="latex-history-item";const u=document.createElement("div");u.className="mb-2 text-center",u.innerHTML=`$$${o.latex}$$`;const m=document.createElement("code");m.className="small d-block mb-2",m.textContent=o.latex.length>50?o.latex.substring(0,50)+"...":o.latex;const h=document.createElement("div");h.className="btn-group w-100";const f=document.createElement("button");f.className="btn btn-sm btn-primary",f.innerHTML='<i class="fas fa-arrow-up"></i>',f.title=e("latex.history.use","Sử dụng"),f.onclick=function(){n.value=o.latex,c(),window.scrollTo({top:0,behavior:"smooth"})};const p=document.createElement("button");p.className="btn btn-sm btn-danger",p.innerHTML='<i class="fas fa-trash"></i>',p.title=e("latex.history.delete","Xóa"),p.onclick=function(){t.splice(i,1),r("latexHistory",t),l()},h.appendChild(f),h.appendChild(p),d.appendChild(u),d.appendChild(m),d.appendChild(h),s.appendChild(d),a.appendChild(s)}),"undefined"!=typeof MathJax&&MathJax.typesetPromise([a]).catch(e=>console.error(e))):a.innerHTML=`<p class="text-muted text-center" data-i18n="latex.no_history">${e("latex.no_history","Chưa có lịch sử")}</p>`}function i(){c();const e=n.value.trim();e&&setTimeout(()=>function(e){if(!e.trim())return;if(t.find(t=>t.latex===e))return;const n={latex:e,timestamp:(new Date).toISOString()};t.unshift(n),t.length>20&&(t=t.slice(0,20)),r("latexHistory",t),l()}(e),1e3)}function r(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("Failed to save to localStorage:",e)}}function s(e,t="info"){const n=document.getElementById("alert-container");if(!n)return;const a=document.createElement("div");a.className=`alert alert-${t} alert-dismissible fade show`,a.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        `,n.appendChild(a),setTimeout(()=>{a.remove()},3e3)}l(),c(),n.addEventListener("input",function(){clearTimeout(o),o=setTimeout(i,500)}),document.getElementById("render-btn").addEventListener("click",c),document.querySelectorAll(".insert-symbol").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-symbol");!function(e,t){const n=e.selectionStart,a=e.selectionEnd,o=e.value;e.value=o.substring(0,n)+t+o.substring(a);const c=n+t.length;e.selectionStart=c,e.selectionEnd=c,e.focus()}(n,e),c()})}),document.getElementById("copy-latex-btn").addEventListener("click",function(){const t=n.value;t.trim()?navigator.clipboard.writeText(t).then(function(){s(e("latex.alert.copied","Đã sao chép mã LaTeX!"),"success"),"undefined"!=typeof gtag&&gtag("event","latex_copied",{event_category:"latex_editor"})}).catch(function(t){s(e("latex.alert.copy_error","Lỗi khi sao chép: ")+t,"error")}):s(e("latex.alert.no_code","Chưa có mã LaTeX để sao chép!"),"warning")}),document.getElementById("save-image-btn").addEventListener("click",async function(){const t=document.getElementById("latex-preview");if(n.value.trim())try{"undefined"!=typeof MathJax&&MathJax.typesetPromise&&await MathJax.typesetPromise([t]);(await html2canvas(t,{backgroundColor:"#ffffff",scale:2,logging:!1})).toBlob(function(t){const n=URL.createObjectURL(t),a=document.createElement("a");a.download=`latex-${Date.now()}.png`,a.href=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),s(e("latex.alert.saved","Đã lưu hình ảnh!"),"success"),"undefined"!=typeof gtag&&gtag("event","latex_image_saved",{event_category:"latex_editor"})})}catch(t){s(e("latex.alert.save_error","Lỗi khi lưu hình: ")+t.message,"error")}else s(e("latex.alert.no_content","Chưa có nội dung để lưu!"),"warning")}),document.getElementById("clear-btn").addEventListener("click",function(){n.value="",a.innerHTML="",n.focus()}),document.getElementById("clear-history-btn").addEventListener("click",function(){confirm(e("latex.alert.clear_history_confirm","Bạn có chắc muốn xóa toàn bộ lịch sử?"))&&(t=[],r("latexHistory",t),l(),s(e("latex.alert.history_cleared","Đã xóa lịch sử!"),"success"))}),n.addEventListener("keydown",function(e){(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),c()),(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),document.getElementById("save-image-btn").click())}),window.addEventListener("languageChanged",function(){l(),c()})});