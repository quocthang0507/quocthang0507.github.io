document.addEventListener("DOMContentLoaded",function(){let e=function(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return console.error("Failed to load from localStorage:",e),null}}("latexHistory")||[];const t=document.getElementById("latex-input"),n=document.getElementById("latex-output");let a=null;function c(){const e=t.value.trim();e?(n.innerHTML=`$$${e}$$`,"undefined"!=typeof MathJax&&(MathJax.typesetClear([n]),MathJax.typesetPromise([n]).catch(function(e){n.innerHTML=`<span class="text-danger">Lỗi cú pháp: ${e.message}</span>`}))):n.innerHTML='<span class="text-muted">Nhập mã LaTeX để xem trước...</span>'}function o(){const n=document.getElementById("latex-history");0!==e.length?(n.innerHTML="",e.forEach((a,l)=>{const s=document.createElement("div");s.className="col-md-4 col-lg-3";const r=document.createElement("div");r.className="latex-history-item";const d=document.createElement("div");d.className="mb-2 text-center",d.innerHTML=`$$${a.latex}$$`;const u=document.createElement("code");u.className="small d-block mb-2",u.textContent=a.latex.length>50?a.latex.substring(0,50)+"...":a.latex;const m=document.createElement("div");m.className="btn-group w-100";const h=document.createElement("button");h.className="btn btn-sm btn-primary",h.innerHTML='<i class="fas fa-arrow-up"></i>',h.title="Sử dụng",h.onclick=function(){t.value=a.latex,c(),window.scrollTo({top:0,behavior:"smooth"})};const f=document.createElement("button");f.className="btn btn-sm btn-danger",f.innerHTML='<i class="fas fa-trash"></i>',f.title="Xóa",f.onclick=function(){e.splice(l,1),i("latexHistory",e),o()},m.appendChild(h),m.appendChild(f),r.appendChild(d),r.appendChild(u),r.appendChild(m),s.appendChild(r),n.appendChild(s)}),"undefined"!=typeof MathJax&&MathJax.typesetPromise([n]).catch(e=>console.error(e))):n.innerHTML='<p class="text-muted text-center" data-i18n="latex.no_history">Chưa có lịch sử</p>'}function l(){c();const n=t.value.trim();n&&setTimeout(()=>function(t){if(!t.trim())return;if(e.find(e=>e.latex===t))return;const n={latex:t,timestamp:(new Date).toISOString()};e.unshift(n),e.length>20&&(e=e.slice(0,20)),i("latexHistory",e),o()}(n),1e3)}function i(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("Failed to save to localStorage:",e)}}function s(e,t="info"){const n=document.getElementById("alert-container");if(!n)return;const a=document.createElement("div");a.className=`alert alert-${t} alert-dismissible fade show`,a.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n        `,n.appendChild(a),setTimeout(()=>{a.remove()},3e3)}o(),c(),t.addEventListener("input",function(){clearTimeout(a),a=setTimeout(l,500)}),document.getElementById("render-btn").addEventListener("click",c),document.querySelectorAll(".insert-symbol").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-symbol");!function(e,t){const n=e.selectionStart,a=e.selectionEnd,c=e.value;e.value=c.substring(0,n)+t+c.substring(a);const o=n+t.length;e.selectionStart=o,e.selectionEnd=o,e.focus()}(t,e),c()})}),document.getElementById("copy-latex-btn").addEventListener("click",function(){const e=t.value;e.trim()?navigator.clipboard.writeText(e).then(function(){s("Đã sao chép mã LaTeX!","success"),"undefined"!=typeof gtag&&gtag("event","latex_copied",{event_category:"latex_editor"})}).catch(function(e){s("Lỗi khi sao chép: "+e,"error")}):s("Chưa có mã LaTeX để sao chép!","warning")}),document.getElementById("save-image-btn").addEventListener("click",async function(){const e=document.getElementById("latex-preview");if(t.value.trim())try{"undefined"!=typeof MathJax&&MathJax.typesetPromise&&await MathJax.typesetPromise([e]);(await html2canvas(e,{backgroundColor:"#ffffff",scale:2,logging:!1})).toBlob(function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.download=`latex-${Date.now()}.png`,n.href=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),s("Đã lưu hình ảnh!","success"),"undefined"!=typeof gtag&&gtag("event","latex_image_saved",{event_category:"latex_editor"})})}catch(e){s("Lỗi khi lưu hình: "+e.message,"error")}else s("Chưa có nội dung để lưu!","warning")}),document.getElementById("clear-btn").addEventListener("click",function(){t.value="",n.innerHTML="",t.focus()}),document.getElementById("clear-history-btn").addEventListener("click",function(){confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")&&(e=[],i("latexHistory",e),o(),s("Đã xóa lịch sử!","success"))}),t.addEventListener("keydown",function(e){(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),c()),(e.ctrlKey||e.metaKey)&&"s"===e.key&&(e.preventDefault(),document.getElementById("save-image-btn").click())})});