document.addEventListener("DOMContentLoaded",function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="abcdefghijklmnopqrstuvwxyz",s="0123456789",n="!@#$%^&*()_+-=[]{}|;:,.<>?/~`",o=document.getElementById("password-display"),a=document.getElementById("copy-password-btn"),r=document.getElementById("generate-btn"),c=document.getElementById("password-length"),d=document.getElementById("length-value"),l=document.getElementById("strength-badge"),i=document.getElementById("strength-bar"),u=document.getElementById("password-history"),p=document.getElementById("clear-history-btn"),m=document.getElementById("include-uppercase"),h=document.getElementById("include-lowercase"),g=document.getElementById("include-numbers"),w=document.getElementById("include-symbols"),y=document.getElementById("exclude-ambiguous"),b=document.getElementById("no-duplicate");let f="",v=loadFromLocalStorage("passwordHistory")||[];function _(e,t){try{if("function"!=typeof window.t)return t;const s=window.t(e);return s&&s!==e?s:t}catch(e){return t}}function E(){const r=parseInt(c.value),d={uppercase:m.checked,lowercase:h.checked,numbers:g.checked,symbols:w.checked,excludeAmbiguous:y.checked,noDuplicate:b.checked};if(!(d.uppercase||d.lowercase||d.numbers||d.symbols))return void showAlert(_("password.error_no_options","Vui lòng chọn ít nhất một loại ký tự!"),"warning");let u="";if(d.uppercase&&(u+=e),d.lowercase&&(u+=t),d.numbers&&(u+=s),d.symbols&&(u+=n),d.excludeAmbiguous&&(u=u.split("").filter(e=>!"0Ol1I".includes(e)).join("")),d.noDuplicate&&u.length<r)return void showAlert(_("password.error_not_enough_chars",`Không đủ ký tự duy nhất (${u.length}) cho độ dài mật khẩu (${r})!`),"warning");let p="";const E=u.split("");if(d.noDuplicate){p=E.sort(()=>Math.random()-.5).slice(0,r).join("")}else for(let e=0;e<r;e++){p+=E[Math.floor(Math.random()*E.length)]}d.noDuplicate||(p=function(o,a){const r=o.split("");let c=!a.uppercase,d=!a.lowercase,l=!a.numbers,i=!a.symbols;for(const o of r)e.includes(o)&&(c=!0),t.includes(o)&&(d=!0),s.includes(o)&&(l=!0),n.includes(o)&&(i=!0);let u=0;!c&&a.uppercase&&(r[u++]=e[Math.floor(26*Math.random())]);!d&&a.lowercase&&(r[u++]=t[Math.floor(26*Math.random())]);!l&&a.numbers&&(r[u++]=s[Math.floor(10*Math.random())]);!i&&a.symbols&&(r[u++]=n[Math.floor(29*Math.random())]);return r.sort(()=>Math.random()-.5).join("")}(p,d)),f=p,o.textContent=p,o.classList.add("generated"),a.disabled=!1,function(e,t){let s=0;const n=e.length;s+=n>=16?40:n>=12?30:n>=8?20:n>=6?10:5;let o=0;t.uppercase&&(o+=10);t.lowercase&&(o+=10);t.numbers&&(o+=10);t.symbols&&(o+=10);s+=o;const a=new Set(e).size,r=a/n*20;let c,d,u;s+=r,s>=80?(c=_("password.very_strong","Rất mạnh"),d="bg-success",u=100):s>=60?(c=_("password.strong","Mạnh"),d="bg-info",u=80):s>=40?(c=_("password.good","Tốt"),d="bg-primary",u=60):s>=20?(c=_("password.weak","Yếu"),d="bg-warning",u=40):(c=_("password.very_weak","Rất yếu"),d="bg-danger",u=20);l.textContent=c,l.className=`badge ${d}`,i.className=`progress-bar ${d}`,i.style.width=`${u}%`,i.setAttribute("aria-valuenow",u)}(p,d),function(e){const t=(new Date).toLocaleString("vi-VN"),s={password:e,timestamp:t,length:e.length};v.unshift(s),v.length>10&&(v=v.slice(0,10));saveToLocalStorage("passwordHistory",v),k()}(p),"undefined"!=typeof gtag&&gtag("event","password_generated",{event_category:"password_tools",event_label:"password_creation",password_length:r,has_uppercase:d.uppercase,has_lowercase:d.lowercase,has_numbers:d.numbers,has_symbols:d.symbols})}function k(){0!==v.length?(u.innerHTML=v.map((e,t)=>`\n            <div class="history-item">\n                <div class="d-flex justify-content-between align-items-center">\n                    <div class="flex-grow-1">\n                        <code class="history-password">${e.password}</code>\n                        <small class="text-muted d-block">${e.timestamp} • ${e.length} ${_("password.characters","ký tự")}</small>\n                    </div>\n                    <button class="btn btn-sm btn-outline-primary copy-history-btn" data-password="${e.password}">\n                        <i class="fas fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n        `).join(""),document.querySelectorAll(".copy-history-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.password;navigator.clipboard.writeText(e).then(()=>{showAlert(_("password.copied","Đã sao chép mật khẩu!"),"success")})})})):u.innerHTML='\n                <p class="text-muted text-center small" data-i18n="password.no_history">Chưa có lịch sử</p>\n            '}k(),c.addEventListener("input",function(){d.textContent=this.value}),r.addEventListener("click",E),a.addEventListener("click",function(){if(!f)return;navigator.clipboard.writeText(f).then(()=>{showAlert(_("password.copied","Đã sao chép mật khẩu!"),"success"),a.innerHTML='<i class="fas fa-check"></i> '+_("password.copied_short","Đã sao chép"),setTimeout(()=>{a.innerHTML='<i class="fas fa-copy"></i> '+_("password.copy","Sao chép")},2e3),"undefined"!=typeof gtag&&gtag("event","password_copied",{event_category:"password_tools",event_label:"clipboard_copy"})}).catch(()=>{showAlert(_("password.copy_error","Không thể sao chép!"),"danger")})}),p.addEventListener("click",function(){if(0===v.length)return;confirm(_("password.confirm_clear","Xóa toàn bộ lịch sử?"))&&(v=[],saveToLocalStorage("passwordHistory",v),k(),showAlert(_("password.history_cleared","Đã xóa lịch sử!"),"info"))}),document.addEventListener("keydown",function(e){"Enter"===e.key&&E()}),E()});