document.addEventListener("DOMContentLoaded",function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="abcdefghijklmnopqrstuvwxyz",n="0123456789",o="!@#$%^&*()_+-=[]{}|;:,.<>?/~`",s=document.getElementById("password-display"),a=document.getElementById("copy-password-btn"),d=document.getElementById("generate-btn"),r=document.getElementById("password-length"),c=document.getElementById("length-value"),i=document.getElementById("strength-badge"),l=document.getElementById("strength-bar"),w=document.getElementById("password-history"),u=document.getElementById("clear-history-btn"),p=document.getElementById("include-uppercase"),m=document.getElementById("include-lowercase"),h=document.getElementById("include-numbers"),g=document.getElementById("include-symbols"),y=document.getElementById("exclude-ambiguous"),b=document.getElementById("no-duplicate");let f="",v=loadFromLocalStorage("passwordHistory")||[];function _(){const d=parseInt(r.value),c={uppercase:p.checked,lowercase:m.checked,numbers:h.checked,symbols:g.checked,excludeAmbiguous:y.checked,noDuplicate:b.checked};if(!(c.uppercase||c.lowercase||c.numbers||c.symbols))return void showAlert(window.t?window.t("password.error_no_options"):"Vui lòng chọn ít nhất một loại ký tự!","warning");let w="";if(c.uppercase&&(w+=e),c.lowercase&&(w+=t),c.numbers&&(w+=n),c.symbols&&(w+=o),c.excludeAmbiguous&&(w=w.split("").filter(e=>!"0Ol1I".includes(e)).join("")),c.noDuplicate&&w.length<d)return void showAlert(window.t?window.t("password.error_not_enough_chars"):`Không đủ ký tự duy nhất (${w.length}) cho độ dài mật khẩu (${d})!`,"warning");let u="";const _=w.split("");if(c.noDuplicate){u=_.sort(()=>Math.random()-.5).slice(0,d).join("")}else for(let e=0;e<d;e++){u+=_[Math.floor(Math.random()*_.length)]}c.noDuplicate||(u=function(s,a){const d=s.split("");let r=!a.uppercase,c=!a.lowercase,i=!a.numbers,l=!a.symbols;for(const s of d)e.includes(s)&&(r=!0),t.includes(s)&&(c=!0),n.includes(s)&&(i=!0),o.includes(s)&&(l=!0);let w=0;!r&&a.uppercase&&(d[w++]=e[Math.floor(26*Math.random())]);!c&&a.lowercase&&(d[w++]=t[Math.floor(26*Math.random())]);!i&&a.numbers&&(d[w++]=n[Math.floor(10*Math.random())]);!l&&a.symbols&&(d[w++]=o[Math.floor(29*Math.random())]);return d.sort(()=>Math.random()-.5).join("")}(u,c)),f=u,s.textContent=u,s.classList.add("generated"),a.disabled=!1,function(e,t){let n=0;const o=e.length;n+=o>=16?40:o>=12?30:o>=8?20:o>=6?10:5;let s=0;t.uppercase&&(s+=10);t.lowercase&&(s+=10);t.numbers&&(s+=10);t.symbols&&(s+=10);n+=s;const a=new Set(e).size,d=a/o*20;let r,c,w;n+=d,n>=80?(r=window.t?window.t("password.very_strong"):"Rất mạnh",c="bg-success",w=100):n>=60?(r=window.t?window.t("password.strong"):"Mạnh",c="bg-info",w=80):n>=40?(r=window.t?window.t("password.good"):"Tốt",c="bg-primary",w=60):n>=20?(r=window.t?window.t("password.weak"):"Yếu",c="bg-warning",w=40):(r=window.t?window.t("password.very_weak"):"Rất yếu",c="bg-danger",w=20);i.textContent=r,i.className=`badge ${c}`,l.className=`progress-bar ${c}`,l.style.width=`${w}%`,l.setAttribute("aria-valuenow",w)}(u,c),function(e){const t=(new Date).toLocaleString("vi-VN"),n={password:e,timestamp:t,length:e.length};v.unshift(n),v.length>10&&(v=v.slice(0,10));saveToLocalStorage("passwordHistory",v),E()}(u),"undefined"!=typeof gtag&&gtag("event","password_generated",{event_category:"password_tools",event_label:"password_creation",password_length:d,has_uppercase:c.uppercase,has_lowercase:c.lowercase,has_numbers:c.numbers,has_symbols:c.symbols})}function E(){0!==v.length?(w.innerHTML=v.map((e,t)=>`\n            <div class="history-item">\n                <div class="d-flex justify-content-between align-items-center">\n                    <div class="flex-grow-1">\n                        <code class="history-password">${e.password}</code>\n                        <small class="text-muted d-block">${e.timestamp} • ${e.length} ${window.t?window.t("password.characters"):"ký tự"}</small>\n                    </div>\n                    <button class="btn btn-sm btn-outline-primary copy-history-btn" data-password="${e.password}">\n                        <i class="fas fa-copy"></i>\n                    </button>\n                </div>\n            </div>\n        `).join(""),document.querySelectorAll(".copy-history-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.password;navigator.clipboard.writeText(e).then(()=>{showAlert(window.t?window.t("password.copied"):"Đã sao chép mật khẩu!","success")})})})):w.innerHTML='\n                <p class="text-muted text-center small" data-i18n="password.no_history">Chưa có lịch sử</p>\n            '}E(),r.addEventListener("input",function(){c.textContent=this.value}),d.addEventListener("click",_),a.addEventListener("click",function(){if(!f)return;navigator.clipboard.writeText(f).then(()=>{showAlert(window.t?window.t("password.copied"):"Đã sao chép mật khẩu!","success"),a.innerHTML='<i class="fas fa-check"></i> '+(window.t?window.t("password.copied_short"):"Đã sao chép"),setTimeout(()=>{a.innerHTML='<i class="fas fa-copy"></i> '+(window.t?window.t("password.copy"):"Sao chép")},2e3),"undefined"!=typeof gtag&&gtag("event","password_copied",{event_category:"password_tools",event_label:"clipboard_copy"})}).catch(()=>{showAlert(window.t?window.t("password.copy_error"):"Không thể sao chép!","danger")})}),u.addEventListener("click",function(){if(0===v.length)return;confirm(window.t?window.t("password.confirm_clear"):"Xóa toàn bộ lịch sử?")&&(v=[],saveToLocalStorage("passwordHistory",v),E(),showAlert(window.t?window.t("password.history_cleared"):"Đã xóa lịch sử!","info"))}),document.addEventListener("keydown",function(e){"Enter"===e.key&&_()}),_()});