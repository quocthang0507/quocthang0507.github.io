document.addEventListener("DOMContentLoaded",function(){let e=loadFromLocalStorage("randomNumberHistory")||[],t=0,n=null;function o(){const e=parseInt(document.getElementById("min-number").value),n=parseInt(document.getElementById("max-number").value);if(isNaN(e)||isNaN(n))return void showAlert("Vui lòng nhập số hợp lệ!","danger");if(e>=n)return void showAlert("Số nhỏ nhất phải nhỏ hơn số lớn nhất!","danger");const o=Math.floor(Math.random()*(n-e+1))+e;s([o],e,n),l([o],e,n),t++,r(),"undefined"!=typeof gtag&&gtag("event","generate_single_number",{event_category:"random_number_tools",event_label:"single_generation",number_range:`${e}-${n}`,generated_number:o})}function s(e,t,o){n=e;const s=document.getElementById("result-display");if(1===e.length)s.textContent=e[0],s.className="result-display result-single";else{let t="multi-small";e.length<=4?t="multi-xl":e.length<=8?t="multi-lg":e.length<=15?t="multi-md":e.length<=30&&(t="multi-sm"),s.innerHTML=`\n                <div class="d-flex flex-wrap justify-content-center gap-2 ${t}">\n                    ${e.map(e=>`<span class="badge bg-primary generated-number">${e}</span>`).join("")}\n                </div>\n            `,s.className="result-display result-multi"}document.getElementById("copy-result-btn").disabled=!1,document.getElementById("save-result-btn").disabled=!1,s.style.animation="none",setTimeout(()=>{s.style.animation="pulse 0.5s ease-in-out"},10)}function l(t,n,o){const s={numbers:t,range:`${n}-${o}`,timestamp:(new Date).toLocaleString("vi-VN"),count:t.length};e.unshift(s),e.length>50&&(e=e.slice(0,50)),saveToLocalStorage("randomNumberHistory",e),a()}function a(){const t=document.getElementById("history-list");if(0===e.length)return t.innerHTML='<p class="text-muted text-center">Chưa có lịch sử</p>',void(document.getElementById("export-history-btn").disabled=!0);document.getElementById("export-history-btn").disabled=!1,t.innerHTML=e.map((e,t)=>`\n            <div class="history-item">\n                <div class="d-flex justify-content-between align-items-start">\n                    <div>\n                        <strong>${1===e.numbers.length?e.numbers[0]:e.numbers.join(", ")}</strong>\n                        <small class="text-muted d-block">Phạm vi: ${e.range}</small>\n                        <small class="text-muted">${e.timestamp}</small>\n                    </div>\n                    <div class="btn-group btn-group-sm">\n                        <button class="btn btn-outline-primary btn-sm copy-history-btn" data-numbers="${e.numbers.join(",")}">\n                            <i class="fas fa-copy"></i>\n                        </button>\n                        <button class="btn btn-outline-danger btn-sm delete-history-btn" data-index="${t}">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `).join(""),document.querySelectorAll(".copy-history-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.numbers;copyToClipboard(e)})}),document.querySelectorAll(".delete-history-btn").forEach(t=>{t.addEventListener("click",function(){!function(t){e.splice(t,1),saveToLocalStorage("randomNumberHistory",e),a(),r(),showAlert("Đã xóa mục khỏi lịch sử","success")}(parseInt(this.dataset.index))})})}function r(){document.getElementById("total-generated").textContent=e.length,document.getElementById("session-count").textContent=t;const n=e.length>0?e[0].range:"-";if(document.getElementById("last-range").textContent=n,e.length>0){const t=e.flatMap(e=>e.numbers),n={};t.forEach(e=>{n[e]=(n[e]||0)+1});const o=Object.keys(n).reduce((e,t)=>n[e]>n[t]?e:t);document.getElementById("most-common").textContent=`${o} (${n[o]}x)`}else document.getElementById("most-common").textContent="-"}a(),r(),document.getElementById("generate-btn").addEventListener("click",o),document.getElementById("generate-multiple-btn").addEventListener("click",function(){const n=parseInt(document.getElementById("min-number").value),o=parseInt(document.getElementById("max-number").value),a=parseInt(document.getElementById("count-numbers").value),i=document.getElementById("unique-numbers").checked,m=!0===document.getElementById("exclude-history")?.checked;if(isNaN(n)||isNaN(o)||isNaN(a))return void showAlert("Vui lòng nhập số hợp lệ!","danger");if(n>=o)return void showAlert("Số nhỏ nhất phải nhỏ hơn số lớn nhất!","danger");if(a<1||a>100)return void showAlert("Số lượng phải từ 1 đến 100!","danger");let c=o-n+1,d=null;if(m){const t=e.filter(e=>!0).flatMap(e=>e.numbers).filter(e=>e>=n&&e<=o);d=new Set(t),c-=d.size}if(i||m){if(a>c)return void showAlert("Không thể tạo đủ số vì phạm vi còn lại quá nhỏ!","danger")}else if(i&&a>o-n+1)return void showAlert("Không thể tạo nhiều số không trùng lặp hơn phạm vi cho phép!","danger");let u=[];if(i||m){let e=[];for(let t=n;t<=o;t++)m&&d.has(t)||e.push(t);for(let t=0;t<a;t++){const t=Math.floor(Math.random()*e.length);u.push(e.splice(t,1)[0])}}else for(let e=0;e<a;e++)u.push(Math.floor(Math.random()*(o-n+1))+n);s(u,n,o),l(u,n,o),t++,r()}),document.getElementById("quick-pick-btn").addEventListener("click",function(){const e=[{min:1,max:6,name:"Xúc xắc"},{min:1,max:100,name:"Phần trăm"},{min:1,max:45,name:"Lotto"},{min:0,max:1,name:"Tung đồng xu"},{min:1,max:20,name:"Số nhỏ"},{min:1,max:1e3,name:"Số lớn"}],t=e[Math.floor(Math.random()*e.length)];document.getElementById("min-number").value=t.min,document.getElementById("max-number").value=t.max,showAlert(`Đã chọn preset: ${t.name} (${t.min}-${t.max})`,"info"),o()}),document.getElementById("copy-result-btn").addEventListener("click",function(){if(n){const e=1===n.length?n[0].toString():n.join(", ");copyToClipboard(e)}}),document.getElementById("save-result-btn").addEventListener("click",function(){n&&showAlert("Kết quả đã được lưu vào lịch sử!","success")}),document.getElementById("clear-history-btn").addEventListener("click",function(){confirm("Bạn có chắc muốn xóa toàn bộ lịch sử?")&&(e=[],saveToLocalStorage("randomNumberHistory",e),a(),r(),showAlert("Đã xóa toàn bộ lịch sử!","success"))}),document.getElementById("export-history-btn").addEventListener("click",function(){if(0===e.length)return void showAlert("Không có lịch sử để xuất!","warning");const t="data:text/csv;charset=utf-8,Số,Phạm vi,Thời gian,Số lượng\n"+e.map(e=>`"${e.numbers.join(", ")}","${e.range}","${e.timestamp}",${e.count}`).join("\n"),n=encodeURI(t),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",`random-numbers-history-${(new Date).toISOString().split("T")[0]}.csv`),document.body.appendChild(o),o.click(),document.body.removeChild(o),showAlert("Đã xuất lịch sử thành công!","success")}),document.getElementById("reset-stats-btn").addEventListener("click",function(){confirm("Bạn có chắc muốn reset toàn bộ thống kê?")&&(t=0,r(),showAlert("Đã reset thống kê!","success"))}),document.querySelectorAll(".preset-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.min,t=this.dataset.max;document.getElementById("min-number").value=e,document.getElementById("max-number").value=t,"undefined"!=typeof gtag&&gtag("event","preset_button_click",{event_category:"random_number_tools",event_label:`preset_${e}_${t}`,preset_range:`${e}-${t}`}),o()})}),document.addEventListener("keypress",function(e){"Enter"===e.key&&o()})});